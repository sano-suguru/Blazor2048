@page "/game"
@using Blazor2048.Components
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using global::Blazor2048.Core
@using global::Blazor2048.GameLogic

<h3>スコア: @gameManager.Score</h3>

@if (gameOver)
{
    <h2>ゲームオーバー！</h2>
    <button @onclick="RestartGame">もう一度プレイ</button>
}

<GameBoard Board="gameManager.Board" OnKeyPress="HandleKeyPress" />

@code {
    [Inject] private GameManager gameManager { get; set; } = default!;
    private bool gameOver = false;

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (gameOver) return;

        Direction? direction = e.Key switch
        {
            "ArrowUp" => Direction.Up,
            "ArrowDown" => Direction.Down,
            "ArrowLeft" => Direction.Left,
            "ArrowRight" => Direction.Right,
            _ => null
        };

        if (direction.HasValue)
        {
            gameManager.Move(direction.Value);
            CheckGameStatus();
        }
    }

    private void CheckGameStatus()
    {
        if (gameManager.IsGameOver()) gameOver = true;
        StateHasChanged();
    }

    private void RestartGame()
    {
        gameManager.Restart();
        gameOver = false;
        StateHasChanged();
    }
}
